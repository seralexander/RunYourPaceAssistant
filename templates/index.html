<!doctype html>
<html lang="nl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RunYourPace Assistant</title>
    <style>
        :root {
            --bg: #ffffff;
            --bg-2: #f7f7f7;
            --panel: #ffffff;
            --panel-strong: #f0f0f0;
            --text: #111111;
            --muted: #555555;
            --accent: #000000;
            --accent-strong: #000000;
            --stroke: #e2e2e2;
            --danger: #b00020;
            --success: #0f8b2c;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 36px 20px 48px;
        }

        header { display: flex; flex-direction: column; gap: 8px; margin-bottom: 22px; }

        .logo-block { display: inline-flex; align-items: center; gap: 10px; }
        .logo-mark { width: 140px; height: 60px; position: relative; background: #0f6a62; overflow: hidden; display: grid; place-items: center; }
        .logo-mark::before { content: ""; position: absolute; inset: 18%; background: #9adf9f; }
        .logo-text { position: relative; font-weight: 800; font-size: 20px; color: #f7fff8; letter-spacing: -0.4px; }

        h1 {
            margin: 0;
            font-weight: 700;
            font-size: clamp(26px, 3.4vw, 34px);
            letter-spacing: -0.4px;
        }

        .subtle {
            margin: 2px 0 0;
            color: var(--muted);
            max-width: 720px;
            line-height: 1.6;
        }

        .grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .step { display: none; }
        .step.active { display: block; }

        .card { background: var(--panel); border: 1px solid var(--stroke); border-radius: 12px; padding: 18px; position: relative; overflow: hidden; }

        .card h2 {
            margin: 0 0 6px;
            font-size: 18px;
            letter-spacing: -0.2px;
        }

        .athlete-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin: 10px 0 4px;
        }

        .athlete-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 12px;
            position: relative;
            cursor: pointer;
            transition: border 0.15s ease, transform 0.12s ease, background 0.12s ease;
        }

        .athlete-card.menu-open { z-index: 30; }

        .athlete-card:hover {
            transform: translateY(-2px);
            border-color: rgba(117, 224, 179, 0.8);
            background: rgba(255, 255, 255, 0.08);
        }

        .athlete-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(117, 224, 179, 0.6);
        }

        .athlete-name {
            font-weight: 700;
            font-size: 15px;
            margin: 0;
        }

        .athlete-id {
            color: var(--muted);
            font-size: 13px;
            margin: 2px 0 6px;
        }

        .athlete-actions {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--stroke);
            border-radius: 10px;
            color: var(--text);
            padding: 6px 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
        }

        .menu-dropdown {
            position: absolute;
            top: 36px;
            right: 0;
            background: #112624;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            padding: 6px;
            display: none;
            min-width: 170px;
            z-index: 10;
        }

        .menu-dropdown.open { display: block; }

        .menu-item {
            width: 100%;
            text-align: left;
            background: transparent;
            color: var(--text);
            border: none;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:hover { background: rgba(255, 255, 255, 0.08); }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
            z-index: 100;
        }

        .modal-backdrop.show { display: flex; }

        .modal {
            background: #0f1f1e;
            border: 1px solid var(--stroke);
            border-radius: 16px;
            width: min(600px, 100%);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 14px 38px rgba(0, 0, 0, 0.36);
        }

        .modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--stroke);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-body {
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .modal-actions {
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid var(--stroke);
        }

        textarea {
            width: 100%;
            min-height: 220px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--text);
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        @media (max-width: 720px) {
            .modal { width: 100%; }
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--muted);
        }

        input[type="text"] {
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 15px;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            cursor: pointer;
            border: none;
            font-weight: 700;
            font-size: 14px;
        }

        .primary {
            background: #000000;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: none;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.14);
        }

        .ghost {
            background: #ffffff;
            color: var(--text);
            padding: 11px 14px;
            border-radius: 12px;
            border: 1px solid var(--stroke);
        }

        .progress {
            width: 100%;
            background: #f0f0f0;
            border-radius: 999px;
            height: 10px;
            overflow: hidden;
            margin-top: 6px;
            border: 1px solid var(--stroke);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: #000;
            transition: width 0.2s ease;
        }

        .chat-log {
            background: #f7f7f7;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            padding: 12px;
            min-height: 120px;
            max-height: 320px;
            overflow-y: auto;
        }

        .chat-item {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .chat-item:last-child { margin-bottom: 0; }

        .chat-role {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #777;
            margin-bottom: 4px;
        }

        .chat-bubble {
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid var(--stroke);
            background: #ffffff;
            color: var(--text);
            display: inline-block;
            max-width: 90%;
        }

        .chat-item.user { align-items: flex-end; }
        .chat-item.user .chat-bubble { background: #fff; }
        .chat-item.agent .chat-bubble { background: #e9e9e9; color: #111; }

        .section-label {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: #f0f0f0;
            font-size: 12px;
            color: #555;
            margin-bottom: 6px;
        }

        .typing {
            font-size: 12px;
            color: #555;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }

        .typing::after {
            content: "...";
            display: inline-block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .icon-btn {
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            background: #ffffff;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--text);
            padding: 0;
            transition: transform 0.12s ease, border 0.15s ease, background 0.15s ease;
        }

        .icon-btn:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(154, 223, 159, 0.8);
        }

        .icon-btn.danger {
            color: var(--danger);
            border-color: rgba(255, 123, 123, 0.45);
        }

        .icon-btn.on-card {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .workout-list {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 12px;
            padding-right: 52px; /* ruimte voor delete-icoon rechtsboven */
            text-align: left;
            color: var(--text);
            transition: border 0.15s ease, transform 0.12s ease, background 0.12s ease;
            position: relative;
        }

        .workout-card:hover {
            transform: translateY(-2px);
            border-color: rgba(154, 223, 159, 0.9);
            background: rgba(255, 255, 255, 0.08);
        }

        .workout-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(154, 223, 159, 0.6);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            font-size: 13px;
            color: var(--text);
        }

        .badge.accent { background: rgba(154, 223, 159, 0.2); color: var(--text); }
        .badge.dim { background: rgba(255, 255, 255, 0.05); color: var(--muted); }

        .title {
            font-weight: 700;
            font-size: 16px;
            margin: 6px 0;
            letter-spacing: -0.1px;
        }

        .meta {
            color: var(--muted);
            font-size: 13px;
        }

        .error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 6px;
        }

        .status {
            margin-top: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--stroke);
            font-size: 14px;
        }

        .status[data-tone="success"] { border-color: #0f8b2c; color: #0f8b2c; }
        .status[data-tone="error"] { border-color: #b00020; color: #b00020; }
        .status[data-tone="warn"] { border-color: #999999; color: #333333; }

        pre {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--stroke);
            color: #111111;
            overflow-x: auto;
            font-size: 13px;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-top: 6px;
        }

        .pill {
            padding: 8px 12px;
            border-radius: 999px;
            background: #f0f0f0;
            font-size: 13px;
            color: var(--muted);
            width: fit-content;
        }

        .dropzone {
            margin-top: 12px;
            border: 1.5px dashed var(--stroke);
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            background: #fafafa;
            transition: border-color 0.15s ease, background 0.15s ease;
        }

        .dropzone.dragover {
            border-color: var(--accent);
            background: #f0f0f0;
        }

        .dropzone p {
            margin: 8px 0 0;
            color: var(--muted);
            font-size: 14px;
        }

        @media (max-width: 720px) {
            header { grid-template-columns: 1fr; }
            .row { flex-direction: column; align-items: stretch; }
            .actions { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <h1>RunYourPace</h1>
            <div class="progress" aria-label="Wizard voortgang">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </header>

        <div class="grid">
            <section class="card step active" data-step="0">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h2 style="margin:0;">1. Athlete ID</h2>
                    <a href="https://intervals.icu/settings" target="_blank" rel="noopener noreferrer" title="Open Intervals.icu settings" style="display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:50%; border:1px solid var(--stroke); text-decoration:none; color:var(--text); font-size:12px;">â†—</a>
                </div>
                <p class="muted" style="margin:0 0 8px;">Geef de Intervals.icu Athlete ID.</p>
                <input id="athleteId" type="text" placeholder="bv. i123456" style="margin-bottom:12px;">
                <div class="pill" id="selectedAthlete">Geen ID gekozen.</div>
                <div class="step-nav" style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
                    <button class="primary" type="button" data-next-step>Volgende</button>
                </div>
            </section>

            <section class="card step" data-step="1">
                <div style="margin-bottom:6px;">
                    <h2 style="margin-bottom:4px;">2. Intake agent</h2>
                    <p class="muted" style="margin:0;">Praat met de agent om je loopprofiel op te bouwen. Wanneer jij denkt dat het profiel volledig is, klik je op 'profiel compleet'. Vervolgens krijg je een verslag. Op basis daarvan zal je schema worden opgebouwd.</p>
                </div>
                <div class="section-label">Gesprek</div>
                <div id="intakeLog" class="chat-log"></div>
                <textarea id="intakeMessage" placeholder="Typ je vraag of info voor de agent..." style="width:100%; min-height:80px; max-height:140px; margin:10px 0;"></textarea>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                    <button class="ghost" type="button" id="intakeSendBtn">Stuur bericht</button>
                    <button class="primary" type="button" id="intakeFinishBtn">Profiel compleet</button>
                    <span class="muted" id="intakeStatus">Nog niets verstuurd.</span>
                </div>
                <div class="step-nav" style="display:flex; justify-content:space-between; gap:8px; margin-top:12px;">
                    <button class="ghost" type="button" data-start-step>Terug naar start</button>
                    <div style="display:flex; gap:8px;">
                        <button class="ghost" type="button" data-prev-step>Vorige</button>
                        <button class="primary" type="button" data-next-step id="requestReportNextBtn">Volgende</button>
                    </div>
                </div>
            </section>

            <section class="card step" data-step="2">
                <div class="actions">
                    <div>
                        <h2 style="margin-bottom:4px;">3. Verslag</h2>
                        <p class="muted" style="margin:0;">Bekijk het gegenereerde verslag. Keur goed en vraag daarna het schema aan.</p>
                    </div>
                </div>
                <div class="section-label" style="margin-top:4px; margin-bottom:6px;">Verslag</div>
                <pre id="intakeReport" style="white-space:pre-wrap;">Nog geen verslag opgevraagd.</pre>
                <div class="step-nav" style="display:flex; justify-content:space-between; gap:8px; margin-top:12px;">
                    <button class="ghost" type="button" data-start-step>Terug naar start</button>
                    <div style="display:flex; gap:8px;">
                        <button class="ghost" type="button" data-prev-step>Vorige</button>
                        <button class="primary" type="button" id="askScheduleBtn">Schema aanmaken</button>
                    </div>
                </div>
            </section>

            <section class="card step" data-step="3">
                <div class="actions">
                    <div>
                        <h2 style="margin-bottom:4px;">4. Schema</h2>
                        <p class="muted" style="margin:0;">Bekijk het schema op basis van het verslag en push naar Intervals.icu.</p>
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                    <span class="muted" id="scheduleStatus">Nog geen schema opgevraagd.</span>
                </div>
                <div class="pill" style="margin-top:4px; margin-bottom:6px;">Schema</div>
                <pre id="scheduleTable" style="white-space:pre-wrap;">-</pre>
                <div class="step-nav" style="display:flex; justify-content:space-between; gap:8px; margin-top:12px;">
                    <button class="ghost" type="button" data-start-step>Terug naar start</button>
                    <div style="display:flex; gap:8px;">
                        <button class="ghost" type="button" data-prev-step>Vorige</button>
                        <button class="primary" type="button" id="pushSchemaBtn" disabled>Schema pushen</button>
                    </div>
                </div>
            </section>
        </div>

        <section class="card step" data-step="4" style="margin-top:16px;">
            <h2 style="margin-bottom:6px;">5. Klaar</h2>
            <p class="muted" style="margin-top:0;">Je hebt alle stappen doorlopen. Keer terug naar start of pas gegevens aan in vorige stappen.</p>
            <div class="pill">Athlete ID: <span id="summaryAthlete">-</span></div>
            <div class="pill" style="margin-top:8px;">Schema status: <span id="summaryWorkout">-</span></div>
            <div class="step-nav" style="display:flex; justify-content:space-between; gap:8px; margin-top:12px;">
                <button class="ghost" type="button" data-start-step>Terug naar start</button>
                <button class="primary" type="button" data-prev-step>Vorige</button>
            </div>
        </section>
    </div>

    <footer style="margin:24px auto 32px; text-align:center;">
        <a href="https://www.runyourpace.be" target="_blank" rel="noopener noreferrer" class="logo-block" style="justify-content:center; margin-bottom:6px; text-decoration:none; color:inherit;">
            <span class="muted" style="text-transform:uppercase; letter-spacing:0.06em; font-size:12px; margin-right:6px;">Powered by</span>
            <span style="font-weight:800; font-size:18px;">RunYourPace</span>
        </a>
    </footer>

    <script>
        const athleteInput = document.getElementById("athleteId");
        const selectedAthlete = document.getElementById("selectedAthlete");
        const summaryAthlete = document.getElementById("summaryAthlete");
        const summaryWorkout = document.getElementById("summaryWorkout");
        const intakeMessage = document.getElementById("intakeMessage");
        const intakeSendBtn = document.getElementById("intakeSendBtn");
        const intakeFinishBtn = document.getElementById("intakeFinishBtn");
        const intakeStatus = document.getElementById("intakeStatus");
        const intakeLog = document.getElementById("intakeLog");
        const intakeReport = document.getElementById("intakeReport");
        const steps = Array.from(document.querySelectorAll("[data-step]"));
        const scheduleStatus = document.getElementById("scheduleStatus");
        const scheduleTable = document.getElementById("scheduleTable");
        const pushSchemaBtn = document.getElementById("pushSchemaBtn");
        const requestReportNextBtn = document.getElementById("requestReportNextBtn");
        const askScheduleBtn = document.getElementById("askScheduleBtn");

        const intakeHistory = [];
        let lastScheduleTable = "";
        let isGeneratingSchedule = false;

        async function fetchJson(url, options) {
            const res = await fetch(url, options);
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                const err = new Error(data.error || `Request mislukt (${res.status})`);
                err.details = data;
                throw err;
            }
            return data;
        }

        function renderIntakeLog() {
            if (!intakeHistory.length) {
                intakeLog.textContent = "Geen berichten.";
                return;
            }
            const typing = document.getElementById("intakeTyping");
            intakeLog.innerHTML = "";
            intakeHistory.forEach((item) => {
            const block = document.createElement("div");
            block.className = `chat-item ${item.role === "user" ? "user" : "agent"}`;

            const role = document.createElement("div");
            role.className = "chat-role";
            role.textContent = item.role === "user" ? "Jij" : "Agent";

                const bubble = document.createElement("div");
                bubble.className = "chat-bubble";
                if (item.role !== "user") bubble.classList.add("agent");
                bubble.textContent = item.text;

                block.appendChild(role);
                block.appendChild(bubble);
                intakeLog.appendChild(block);
            });
            if (typing) intakeLog.appendChild(typing);
            intakeLog.scrollTop = intakeLog.scrollHeight;
        }

        function setIntakeStatus(text) {
            intakeStatus.textContent = text;
        }

        async function sendIntakeMessage() {
            const message = intakeMessage.value.trim();
            if (!message) {
                setIntakeStatus("Typ eerst een bericht.");
                return;
            }
            // Toon direct in log en clear input
            intakeHistory.push({ role: "user", text: message });
            renderIntakeLog();
            intakeMessage.value = "";
            intakeSendBtn.disabled = true;
            intakeFinishBtn.disabled = true;
            setIntakeStatus("Agent request loopt...");
            setIntakeLoading(true);
            try {
                const res = await fetchJson("/api/intake", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message, transcript: intakeHistory }),
                });
                intakeHistory.push({ role: "agent", text: res.reply || "(geen antwoord)" });
                renderIntakeLog();
                setIntakeStatus("Antwoord ontvangen.");
            } catch (err) {
                setIntakeStatus(err.message);
            } finally {
                intakeSendBtn.disabled = false;
                intakeFinishBtn.disabled = false;
                setIntakeLoading(false);
            }
        }

        async function requestIntakeReport() {
            if (!intakeHistory.length) {
                setIntakeStatus("Geen gesprek om samen te vatten.");
                return;
            }
            intakeFinishBtn.disabled = true;
            intakeSendBtn.disabled = true;
            setIntakeStatus("Verslag wordt opgevraagd...");
            setIntakeLoading(true);
            const transcript = intakeHistory.map((item) => `${item.role}: ${item.text}`).join("\n");
            const prompt = `Gebruik dit intakegesprek om een kort verslag te schrijven (max 12 regels) en eindig met 3 bulletpunten:\n\n${transcript}`;
            try {
                const res = await fetchJson("/api/intake", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: prompt, transcript: intakeHistory }),
                });
                intakeReport.textContent = res.reply || "(geen verslag ontvangen)";
                setIntakeStatus("Verslag ontvangen.");
            } catch (err) {
                setIntakeStatus(err.message);
                intakeReport.textContent = err.details ? JSON.stringify(err.details, null, 2) : err.message;
            } finally {
                intakeFinishBtn.disabled = false;
                intakeSendBtn.disabled = false;
                setIntakeLoading(false);
            }
        }

        let currentStep = 0;

        function showStep(index) {
            if (index < 0 || index >= steps.length) return;
            steps.forEach((step, idx) => {
                step.classList.toggle("active", idx === index);
            });
            currentStep = index;
            updateProgress();
            if (currentStep === 2 && !lastScheduleTable && !isGeneratingSchedule) {
                generateSchedule();
            }
        }

        function goNextStep() {
            if (currentStep < steps.length - 1) {
                showStep(currentStep + 1);
            }
        }

        function goPrevStep() {
            if (currentStep > 0) {
                showStep(currentStep - 1);
            }
        }

        function goStart() {
            showStep(0);
        }

        function updateProgress() {
            const percent = ((currentStep + 1) / steps.length) * 100;
            const bar = document.getElementById("progressFill");
            if (bar) {
                bar.style.width = `${percent}%`;
            }
        }

        function setIntakeLoading(state) {
            // Toon/hide typing indicator als chat-item
            let typing = document.getElementById("intakeTyping");
            if (state) {
                if (!typing) {
                    typing = document.createElement("div");
                    typing.id = "intakeTyping";
                    typing.className = "chat-item typing";
                    typing.textContent = "ðŸƒâ€â™‚ï¸ Antwoord wordt opgehaald";
                    intakeLog.appendChild(typing);
                }
                typing.style.display = "inline-flex";
                intakeLog.scrollTop = intakeLog.scrollHeight;
            } else if (typing) {
                typing.style.display = "none";
            }
        }

        async function generateSchedule() {
            const report = intakeReport.textContent || "";
            if (!report || report.startsWith("Nog geen verslag")) {
                scheduleStatus.textContent = "Geen intake-verslag beschikbaar.";
                return;
            }
            scheduleStatus.textContent = "Schema wordt opgehaald...";
            isGeneratingSchedule = true;
            pushSchemaBtn.disabled = true;
            scheduleTable.textContent = "ðŸƒâ€â™‚ï¸ Schema wordt geladen...";
            try {
                const res = await fetchJson("/api/schedule-table", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ report }),
                });
                lastScheduleTable = res.reply || "";
                scheduleTable.textContent = lastScheduleTable || "(geen schema)";
                scheduleStatus.textContent = "Schema ontvangen.";
                pushSchemaBtn.disabled = !lastScheduleTable;
            } catch (err) {
                scheduleStatus.textContent = err.message;
            } finally {
                isGeneratingSchedule = false;
            }
        }

        async function approveAndPush() {
            const athleteId = athleteInput.value.trim();
            if (!athleteId) {
                scheduleStatus.textContent = "Vul eerst een Athlete ID in (stap 1).";
                return;
            }
            if (!lastScheduleTable) {
                scheduleStatus.textContent = "Genereer eerst een schema.";
                return;
            }
            scheduleStatus.textContent = "Schema wordt omgezet naar JSON en gepusht...";
            pushSchemaBtn.disabled = true;
            try {
                const res = await fetchJson("/api/schedule-json-push", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ schemaText: lastScheduleTable, athleteId }),
                });
                scheduleStatus.textContent = `Push uitgevoerd (status ${res.apiStatus}).`;
                summaryWorkout.textContent = "Schema gepusht";
                goNextStep();
            } catch (err) {
                scheduleStatus.textContent = err.message;
            } finally {
                pushSchemaBtn.disabled = false;
            }
        }

        intakeSendBtn.addEventListener("click", sendIntakeMessage);
        intakeFinishBtn.addEventListener("click", requestIntakeReport);
        requestReportNextBtn.addEventListener("click", async () => {
            await requestIntakeReport();
            if (intakeReport.textContent && !intakeReport.textContent.startsWith("Nog geen verslag")) {
                goNextStep();
            }
        });
        askScheduleBtn.addEventListener("click", async () => {
            // Ga meteen naar de schema-stap en toon een loader
            goNextStep();
            scheduleStatus.textContent = "Schema wordt aangemaakt...";
            scheduleTable.textContent = "ðŸƒâ€â™‚ï¸ Schema wordt geladen...";
            pushSchemaBtn.disabled = true;
            await generateSchedule();
        });
        pushSchemaBtn.addEventListener("click", approveAndPush);
        intakeMessage.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendIntakeMessage();
            }
        });
        athleteInput.addEventListener("input", () => {
            const value = athleteInput.value.trim();
            selectedAthlete.textContent = value ? `Gekozen ID: ${value}` : "Geen ID gekozen.";
            summaryAthlete.textContent = value || "-";
        });

        document.querySelectorAll("[data-next-step]").forEach((btn) => btn.addEventListener("click", goNextStep));
        document.querySelectorAll("[data-prev-step]").forEach((btn) => btn.addEventListener("click", goPrevStep));
        document.querySelectorAll("[data-start-step]").forEach((btn) => btn.addEventListener("click", goStart));

        showStep(0);
        summaryAthlete.textContent = athleteInput.value.trim() || "-";
        updateProgress();

        scheduleStatus.textContent = "Nog geen schema opgevraagd.";
        pushSchemaBtn.disabled = true;
    </script>
</body>
</html>
